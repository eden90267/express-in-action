# chap09. 測試Express應用程序

>**本章涵蓋**  
>測試是如何確保你代碼的行為
>常規測試練習  
>利用Mocha和Chai在Node.js進行測試  
>使用Mocha, SuperTest以及Cheerio

讓代碼更加可靠：

- 編輯器和語法檢查器，會自動掃瞄程序的潛在bug
- 代碼效驗，可讓其他人找到他們編寫錯誤的地方
- 風格指南，可幫助你的開發團隊保持一致

自動化測試是另一個解決bug的強力方式。自動化測試讓你編寫你想要的軟件特性，然後讓你更加自信的說“我的代碼工作了！”。它能夠讓你在代碼崩潰的情況下準確無誤的重構代碼，並且在代碼錯誤的時候你也可以很容易地獲取反饋信息。

如果你想要讓你的Express應用程序獲得這些好處。本章結束後，你將：

- 從總的方向上理解測試的作用
- 了解測試的類型
- 能夠做到測試驅動開發(TDD)，理解並使用red-green-refactor模組進行開發
- 為普通的Node.js代碼來編寫、運行，和組織測試，從而確保你的函數和模型能夠達到預期(使用**Mocha**和**Chai**工具)
- 測試你的Express應用程序，從而確保你的Server特性能達到預期效果(使用**SuperTest**模組)
- 測試響應的HTML並保證視圖生成了正確的HTML(使用一個類jQuery模組**Cheerio**)

## 什麼是測試？ 為什麼測試這麼重要？

通常，我們**想像出來的代碼行為**和其**實際的代碼行為**通常是沒有聯繫的。沒有任何程序的代碼會永遠100%無bug的；進行測試是我們工作中的一部分。

自動化測試有效規範化你的程序，但它並不是用文字語言編寫的；它是在電腦中編寫的代碼，這就意味著你可以自動驗證它。測試通常是自動化測試的簡稱，並且它也意味著運行測試代碼來檢查你的實際代碼。

自動化驗證最主要是讓你對代碼的可靠度更加自信。

在你想要變更你的代碼的時候它同樣很有幫助。可自信的認為這次重構沒有破壞任何東西。

編寫測試從而使得你可以自動認證你代碼的任務。

### 測試驅動開發

一開始就編寫測試會有很多的好處。當你最開始編寫測試的時候，你直接編寫你的規範。當你完成測試的編寫，你已經告訴了電腦如何詢問"我的代碼編寫完畢了嗎?"如果你有任何的錯誤測試，則說明你的代碼沒有符合規範。如果所有的測試都通過了，則說明你的代碼符合你的逾期。如果一開始就編寫代碼的話很可能會誤導你，這會導致你編寫不出完整的測試。

一開始就編寫測試的時候，你不得不在你真正編寫代碼前考慮你的代碼應該如何工作。這樣可以幫助你設計想像中的代碼。TDD可以幫助你顧全大局，明白你的代碼應該如何工作同時進行更加優雅的設計。

"優先編寫測試"的哲學被稱為測試驅動開發，簡稱TDD。之所以這命名是因為**測試決定你的代碼形式**。

TDD真的可以幫助到你，不過有些時候它會放慢你的速度。如果你的規範不明確，你可能花費很多時間編寫測試，除非意識到你不打算實現什麼!現在你已經編寫所有的無用測試並且花費了很多時間。除非你的規範有點模糊，否則TDD將會限制你程序的靈活性。如果你根本沒有編寫任何的測試，那麼你就是與TDD哲學背道而馳了。

TDD決定是否適合你和你的代碼。TDD適用於某些場景，也不適用於其他場景。

#### TDD是如何工作的：紅、綠、重構

![](http://i.imgur.com/4jQ9HpL.png)

TDD週期通常會重複這三個步驟，調用紅、綠、重構。

1. 紅色步驟。

    TDD，所以你優先編寫測試。在你真正開始編碼之前，你編寫了這些測試，這時不會有任何測試被通過──在沒有真正編寫代碼的時候它們可以怎麼樣呢?

    在紅色步驟期間，你編寫了所有測試，你編寫它們並看到它們全部失敗。這個步驟之所以命名紅色，是因為你總是會看到你的測試失敗。

2. 綠色步驟。

    現在你編寫了你所有的測試，你開始編寫真實的代碼來滿足所有的測試。當你取得進展，你的測試將會慢慢由紅(failing)轉綠(passing)。一旦你全部都是綠色，你就可以準備步驟3了。

3. 重構步驟。

    如果你所有測試都變綠了，這就意味著你所有的代碼都正常工作了，不過它可能不夠完善。假設你的函數速度很慢或你的變數名稱用的不好。就像一個作者清理一抽屜的書，你回頭清理你的代碼。因為你已經有了所有的測試，在你進行重構的時候你可以不用擔心會對代碼造成一些不可預見的問題。

4. 重複流程。

    你程序的所有代碼都已經編寫完成了，所以我們回到步驟1，然後為下一部份編寫測試。

### 首要原則：有疑問時進行測試

簡單來說，你可以沒有太多的測試。你可以想像，測試成功並不能意味著你的代碼運作了，不過這會是個好的開始。出於這個原因，你想要盡可能測試你的代碼。你想要涉及你軟件的每一個(合理)的角落，從而確保它的表現符合你的預期。通過的測試越多，代碼的運作就越符合你的預期。你沒有辦法100%肯定，一些代碼會在你沒想到的地方崩潰，但是如果你在代碼中任何你能想到的地方拋出錯誤，它可能就會工作了。

>**代碼覆蓋率**  
>測試使你代碼增加信心，不過它也僅是一個方法。就像我們開頭講的那樣，還有大量的諸如代碼審查和代碼簡化的其他方法。一個擴展測試會透過代碼覆蓋率來進一步增強你的信心。  
>代碼覆蓋率工聚會檢測你有多少代碼被測試了。Node中最普遍的代碼覆蓋率工具應該是[Istanbul](https://github.com/gotwarlost/istanbul)。

不編寫測試的唯一理由就是它會花費時間。它同樣會讓電腦花費時間──一些測試會花費較長時間──並且它也會讓你失去時間──它需要時間去測試類型。

## 介紹Mocha測試框架